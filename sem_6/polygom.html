<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <p>Сначала ЛКМ строится многоугольник,
        по нажатию ПКМ от достраивает последний кусок.
        После этого по 2 щелчку ЛКМ заполняется полигон</p>
</head>
<BODY>
<canvas id="canvas" width="800" height="800">
</canvas>
<script src="draw.js"></script>
<script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let state = 0;
    let polygon_start_x_tmp, polygon_start_y_tmp;
    let polygon_start_x, polygon_start_y;
    let polygon_end_x, polygon_end_y;
    const polygon_lines = new Map();

    canvas.addEventListener("click", function (event) {
        if (state === 0) {
            polygon_start_x_tmp = event.offsetX;
            polygon_start_y_tmp = event.offsetY;
            polygon_start_x = event.offsetX;
            polygon_start_y = event.offsetY;
            state = 1;
        } else if (state === 1) {
            polygon_end_x = event.offsetX;
            polygon_end_y = event.offsetY;
            draw_line(ctx, polygon_start_x_tmp, polygon_start_y_tmp, polygon_end_x, polygon_end_y);
            polygon_lines.set([polygon_start_x_tmp, polygon_start_y_tmp], [polygon_end_x, polygon_end_y]);
            polygon_start_x_tmp = event.offsetX;
            polygon_start_y_tmp = event.offsetY;
            state = 1;
        } else if (state === 2) {
            let dot_map = get_reference_points(polygon_lines)
            ctx.fillStyle = '#002eff'
            for (const y0 of dot_map.keys()) {
                for (let i = 0; i < dot_map.get(y0).length - 1; i += 4) {
                    draw_line(ctx, dot_map.get(y0)[i], y0, dot_map.get(y0)[i + 2], dot_map.get(y0)[i + 3]);
                    draw_line(ctx, dot_map.get(y0)[i], y0, dot_map.get(y0)[i + 2], dot_map.get(y0)[i + 3]);
                    draw_line(ctx, dot_map.get(y0)[i], y0, dot_map.get(y0)[i + 2], dot_map.get(y0)[i + 3]);
                    draw_line(ctx, dot_map.get(y0)[i], y0, dot_map.get(y0)[i + 2], dot_map.get(y0)[i + 3]);
                    draw_line(ctx, dot_map.get(y0)[i], y0, dot_map.get(y0)[i + 2], dot_map.get(y0)[i + 3]);
                }

            }
        }

    });

    canvas.addEventListener('contextmenu', function (event) {
        if (state === 1) {
            draw_line(ctx, polygon_start_x_tmp, polygon_start_y_tmp, polygon_start_x, polygon_start_y);
            polygon_lines.set([polygon_start_x_tmp, polygon_start_y_tmp], [polygon_start_x, polygon_start_y])
            state = 2;
        }
    });

</script>
</BODY>
</html>